#!/usr/bin/env bash

# Stop on errors
set -e

ROOT="$( cd "$( dirname "$(readlink -f "$0")" )/.." >/dev/null 2>&1 && pwd )"
cd "${ROOT}"

# Load common functions
source ./bin/_common

HASSIO_CONFIG="${ROOT}/dev-config"

component=$(ls -q "${ROOT}/custom_components/" | grep -v __)

[[ -d "${HASSIO_CONFIG}/custom_components" ]] || die "ERROR: Home Assistant development configs are not configured."

pytest || die

if [[ -d "${HASSIO_CONFIG}/custom_components" ]]; then
    log.info "Removing old version of component '${component}'..."
    cd "${HASSIO_CONFIG}/custom_components"
    rm -Rf "${component}"
fi

log.info "Copy new version of component '${component}'..."
install -d "${HASSIO_CONFIG}/custom_components"
cp -R "${ROOT}/custom_components/${component}" "${HASSIO_CONFIG}/custom_components"
